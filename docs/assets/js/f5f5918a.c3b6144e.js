"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[308],{452:function(e,a,t){t.r(a),t.d(a,{frontMatter:function(){return s},contentTitle:function(){return o},metadata:function(){return d},toc:function(){return p},default:function(){return m}});var i=t(7462),l=t(3366),r=(t(7294),t(3905)),n=["components"],s={sidebar_position:15},o="Manual helm to operator upgrade of xlr from version 10 to above 22.1 version.",d={unversionedId:"manual/manual-upgrade-for-xlr-10",id:"manual/manual-upgrade-for-xlr-10",isDocsHomePage:!1,title:"Manual helm to operator upgrade of xlr from version 10 to above 22.1 version.",description:"This is internal documentation. This document can be used only if it was recommended by the Support Team.",source:"@site/docs/manual/manual-upgrade-for-xlr-10.md",sourceDirName:"manual",slug:"/manual/manual-upgrade-for-xlr-10",permalink:"/xl-release-kubernetes-operator/docs/manual/manual-upgrade-for-xlr-10",tags:[],version:"current",sidebarPosition:15,frontMatter:{sidebar_position:15},sidebar:"tutorialSidebar",previous:{title:"Move PVC to other namespace",permalink:"/xl-release-kubernetes-operator/docs/manual/move_pvc_to_other_namespace"}},p=[{value:"Prerequisites",id:"prerequisites",children:[],level:2},{value:"1. Backup everything",id:"1-backup-everything",children:[],level:2},{value:"2. Update PV  RECLAIM POLICY To Retain",id:"2-update-pv--reclaim-policy-to-retain",children:[],level:2},{value:"3. Creating new PVC for dai-release by copying PV data.",id:"3-creating-new-pvc-for-dai-release-by-copying-pv-data",children:[{value:"i. Make the copy of the pvc-xlr-prod-digitalai-release.yaml for the later reference.",id:"i-make-the-copy-of-the-pvc-xlr-prod-digitalai-releaseyaml-for-the-later-reference",children:[],level:3},{value:"ii. Manually create pvc dai-xlr-digitalai-release as mentioned below.",id:"ii-manually-create-pvc-dai-xlr-digitalai-release-as-mentioned-below",children:[],level:3},{value:"iii.  Create PVC dai-xlr-digitalai-release.",id:"iii--create-pvc-dai-xlr-digitalai-release",children:[],level:3},{value:"iv. Verify if PV bounded",id:"iv-verify-if-pv-bounded",children:[],level:3},{value:"v. Update the Reclaim policy to Retain, for newly created pv of dai-xlr-digitalai-release.",id:"v-update-the-reclaim-policy-to-retain-for-newly-created-pv-of-dai-xlr-digitalai-release",children:[],level:3},{value:"vi. Start the following pod for accessing the newly created PVC dai-xlr-digitalai-release.",id:"vi-start-the-following-pod-for-accessing-the-newly-created-pvc-dai-xlr-digitalai-release",children:[],level:3},{value:"vii. Copy data and Give Persmission.",id:"vii-copy-data-and-give-persmission",children:[],level:3},{value:"viii.  Delete the pod.",id:"viii--delete-the-pod",children:[],level:3}],level:2},{value:"4. Run upgrade with dry run, with custom zip options.",id:"4-run-upgrade-with-dry-run-with-custom-zip-options",children:[],level:2},{value:"5. Take backup of existing password.",id:"5-take-backup-of-existing-password",children:[],level:2},{value:"6. Do following changes in the xebialabs/dai-release/dairelease_cr.yaml, based on the requirement.",id:"6-do-following-changes-in-the-xebialabsdai-releasedairelease_cryaml-based-on-the-requirement",children:[{value:"i. To update admin password",id:"i-to-update-admin-password",children:[],level:3},{value:"ii.  To setup haproxy/nginx.",id:"ii--to-setup-haproxynginx",children:[],level:3},{value:"iii. To update the rabbitmq Persistence storageclass.",id:"iii-to-update-the-rabbitmq-persistence-storageclass",children:[],level:3},{value:"iii. To reuse existing claim for postgres/rabbitmq",id:"iii-to-reuse-existing-claim-for-postgresrabbitmq",children:[],level:3},{value:"iv. To setup oidc",id:"iv-to-setup-oidc",children:[],level:3}],level:2},{value:"7. Bring up the xl-deploy in docker.",id:"7-bring-up-the-xl-deploy-in-docker",children:[],level:2},{value:"8. Uninstall helm.",id:"8-uninstall-helm",children:[],level:2},{value:"9. Below steps are specific to AWS EKS Cluster, with SSO access.",id:"9-below-steps-are-specific-to-aws-eks-cluster-with-sso-access",children:[{value:"1. Verify if we have clusterRole configured with assumeRole trustPolicy.",id:"1-verify-if-we-have-clusterrole-configured-with-assumerole-trustpolicy",children:[],level:3},{value:"2. Configure IAM users or roles to your Amazon EKS cluster.",id:"2-configure-iam-users-or-roles-to-your-amazon-eks-cluster",children:[],level:3}],level:2},{value:"10. Run the following command.",id:"10-run-the-following-command",children:[],level:2},{value:"11. Verify the PVC and PV.",id:"11-verify-the-pvc-and-pv",children:[],level:2}],c={toc:p};function m(e){var a=e.components,t=(0,l.Z)(e,n);return(0,r.kt)("wrapper",(0,i.Z)({},c,t,{components:a,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"manual-helm-to-operator-upgrade-of-xlr-from-version-10-to-above-221-version"},"Manual helm to operator upgrade of xlr from version 10 to above 22.1 version."),(0,r.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"This is internal documentation. This document can be used only if it was recommended by the Support Team."))),(0,r.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The kubectl command-line tool"),(0,r.kt)("li",{parentName:"ul"},"Access to a Kubernetes cluster with installed Release in the ",(0,r.kt)("inlineCode",{parentName:"li"},"default")," namespace")),(0,r.kt)("h2",{id:"1-backup-everything"},"1. ",(0,r.kt)("a",{parentName:"h2",href:"https://xebialabs.github.io/xl-release-kubernetes-operator/docs/manual/move_pvc_to_other_namespace#c1-backup-everything"},"Backup everything")),(0,r.kt)("h2",{id:"2-update-pv--reclaim-policy-to-retain"},"2. ",(0,r.kt)("a",{parentName:"h2",href:"https://xebialabs.github.io/xl-release-kubernetes-operator/docs/manual/move_pvc_to_other_namespace/#c2-be-sure-to-not-delete-pvs-with-your-actions"},"Update PV  RECLAIM POLICY To Retain")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'eg:\n> kubectl patch pv pvc-1bc9fb12-b55b-4efa-a3b6-c25700b07c0e -p \'{"spec":{"persistentVolumeReclaimPolicy":"Retain"}}\';\n\n[sishwarya@localhost xl-release-kubernetes-helm-chart] (10.0) $ kubectl get pv\nNAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                STORAGECLASS          REASON   AGE\npvc-38314489-068a-42e7-bc65-cc9491c5457c   50Gi       RWO            Retain           Bound    default/data-xlr-prod-postgresql-0   aws-efs-provisioner            4m58s\npvc-6d03813b-1438-41ee-93c9-3f32efe73e47   8Gi        RWO            Retain           Bound    default/data-xlr-prod-rabbitmq-1     aws-efs-provisioner            4m13s\npvc-783d538b-532f-4ed5-a0be-2ce4fe91975e   5Gi        RWO            Retain           Bound    default/xlr-prod-digitalai-release   aws-efs-provisioner            5m\npvc-808b52b0-4851-44ff-a950-a61e4ff842ca   8Gi        RWO            Retain           Bound    default/data-xlr-prod-rabbitmq-2     aws-efs-provisioner            3m12s\npvc-f36a89a9-d48d-49dc-a210-a43c7d1a3862   8Gi        RWO            Retain           Bound    default/data-xlr-prod-rabbitmq-0     aws-efs-provisioner            4m58s\n\n')),(0,r.kt)("h2",{id:"3-creating-new-pvc-for-dai-release-by-copying-pv-data"},"3. Creating new PVC for dai-release by copying PV data."),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"eg: helm release name : xlr-prod"))),(0,r.kt)("h3",{id:"i-make-the-copy-of-the-pvc-xlr-prod-digitalai-releaseyaml-for-the-later-reference"},"i. Make the copy of the pvc-xlr-prod-digitalai-release.yaml for the later reference."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"> kubectl get pvc xlr-prod-digitalai-release -o yaml > pvc-xlr-prod-digitalai-release.yaml.\n")),(0,r.kt)("h3",{id:"ii-manually-create-pvc-dai-xlr-digitalai-release-as-mentioned-below"},"ii. Manually create pvc dai-xlr-digitalai-release as mentioned below."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Copy the pvc-release-name-digitalai-release.yaml file  to pvc-dai-xlr-digitalai-release.yaml",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"}," > cp pvc-xlr-prod-digitalai-release.yaml pvc-dai-xlr-digitalai-release.yaml\n"))),(0,r.kt)("li",{parentName:"ul"},"Delete all the lines under sections:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"status\nspec.volumneMode\nspec.volumneName\nmetadata.uid\nmetadata.resourceVersion\nmetadata.ownerReferences\nmetadata.namespace\nmetadata.creationTimestamp\nmetadata.finalizers\nmetadata.annotations.pv.kubernetes.io/bind-completed\nmetadata.annotations.pv.kubernetes.io/bound-by-controller\n"))),(0,r.kt)("li",{parentName:"ul"},"Update the following in yaml:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"metadata.name from <release-name>-digitalai-release to dai-xlr-digitalai-release\nmetadata.labels.release: dai-xlr\nmetadata.annotations.meta.helm.sh/release-namespace: default\nmetadata.annotations.meta.helm.sh/release-name : dai-xlr\netadata.annotations:helm.sh/resource-policy: keep \n")))),(0,r.kt)("h3",{id:"iii--create-pvc-dai-xlr-digitalai-release"},"iii.  Create PVC dai-xlr-digitalai-release."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"   > kubectl apply -f pvc-dai-xlr-digitalai-release.yaml\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"      [sishwarya@localhost docs] $ kubectl apply -f pvc-dai-xlr-digitalai-release.yaml\n      persistentvolumeclaim/dai-xlr-digitalai-release created\n")),(0,r.kt)("h3",{id:"iv-verify-if-pv-bounded"},"iv. Verify if PV bounded"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"[sishwarya@localhost docs] $ kubectl get pvc dai-xlr-digitalai-release\nNAME                        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE\ndai-xlr-digitalai-release   Bound    pvc-dad9e7c3-ae1b-4b28-b595-4f4b281a0bf2   5Gi        RWO            aws-efs-provisioner   53s\n\n[sishwarya@localhost docs] $ kubectl get pv pvc-dad9e7c3-ae1b-4b28-b595-4f4b281a0bf2\nNAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                               STORAGECLASS          REASON   AGE\npvc-dad9e7c3-ae1b-4b28-b595-4f4b281a0bf2   5Gi        RWO            Delete           Bound    default/dai-xlr-digitalai-release   aws-efs-provisioner            64s\n")),(0,r.kt)("h3",{id:"v-update-the-reclaim-policy-to-retain-for-newly-created-pv-of-dai-xlr-digitalai-release"},"v. Update the Reclaim policy to Retain, for newly created pv of dai-xlr-digitalai-release."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},' [sishwarya@localhost docs] $ kubectl patch pv pvc-dad9e7c3-ae1b-4b28-b595-4f4b281a0bf2 -p \'{"spec":{"persistentVolumeReclaimPolicy":"Retain"}}\';\n persistentvolume/pvc-dad9e7c3-ae1b-4b28-b595-4f4b281a0bf2 patched\n [sishwarya@localhost docs] $ kubectl get pv pvc-dad9e7c3-ae1b-4b28-b595-4f4b281a0bf2\n NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                               STORAGECLASS          REASON   AGE\n pvc-dad9e7c3-ae1b-4b28-b595-4f4b281a0bf2   5Gi        RWO            Retain           Bound    default/dai-xlr-digitalai-release   aws-efs-provisioner            3m40s\n')),(0,r.kt)("h3",{id:"vi-start-the-following-pod-for-accessing-the-newly-created-pvc-dai-xlr-digitalai-release"},"vi. Start the following pod for accessing the newly created PVC ","[dai-xlr-digitalai-release]","."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Update the pod ","[pod-dai-xlr-digitalai-release.yaml]"," yaml with exact volumes which we mounted in previous installation."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'apiVersion: v1\nkind: Pod\nmetadata:\nname: pod-dai-xlr-digitalai-release\nspec:  \ncontainers:\n  - name: sleeper      \n    command: ["sleep", "1d"]\n    image: xebialabs/tiny-tools:22.2.0\n    imagePullPolicy: Always\n    volumeMounts:\n      - mountPath: /opt/xebialabs/xl-release-server/reports\n        name: reports-dir\n        subPath: reports           \nrestartPolicy: Never\nvolumes:\n  - name: reports-dir\n    persistentVolumeClaim:\n      claimName: dai-xlr-digitalai-release\n'))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Start the pod"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"  [sishwarya@localhost docs] $ kubectl apply -f pod-dai-xlr-digitalai-release.yaml\n  pod/pod-dai-xlr-digitalai-release created\n")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"  [sishwarya@localhost docs] $ kubectl get pod/pod-dai-xlr-digitalai-release\n  NAME                            READY   STATUS    RESTARTS   AGE\n  pod-dai-xlr-digitalai-release   1/1     Running   0          34s\n")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Verify the mouted path is available in newly created PV.")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"   [sishwarya@localhost docs] $ kubectl exec -it pod/pod-dai-xlr-digitalai-release -- sh\n   / # cd /opt/xebialabs/xl-release-server/\n   /opt/xebialabs/xl-release-server # ls -lrt reports\n   total 0\n   /opt/xebialabs/xl-release-server #\n")))),(0,r.kt)("h3",{id:"vii-copy-data-and-give-persmission"},"vii. Copy data and Give Persmission."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Copy data from xlr-prod-digitalai-release-0 to pod-dai-xlr-digitalai-release")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"    > kubectl exec -n default xlr-prod-digitalai-release-0 -- tar cf - /opt/xebialabs/xl-release-server/reports | kubectl exec -n default -i pod-dai-xlr-digitalai-release -- tar xvf - -C /\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'eg:\n    [sishwarya@localhost docs] $ kubectl exec -n default xlr-prod-digitalai-release-0 -- tar cf - /opt/xebialabs/xl-release-server/reports | kubectl exec -n default -i pod-dai-xlr-digitalai-release -- tar xvf - -C /\n    Defaulted container "digitalai-release" out of: digitalai-release, wait-for-db (init)\n    tar: Removing leading `/\' from member names\n    opt/xebialabs/xl-release-server/reports/\n    opt/xebialabs/xl-release-server/reports/testupgrade/\n    opt/xebialabs/xl-release-server/reports/testupgrade/readme.txt\n    opt/xebialabs/xl-release-server/reports/readme.txt\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Give full Permission to the copied data in new PV.",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"  [sishwarya@localhost docs] $ kubectl exec -it pod/pod-dai-xlr-digitalai-release -- sh\n  / # cd /opt/xebialabs/xl-release-server/\n  /opt/xebialabs/xl-release-server # chmod -R 777 reports/\n  /opt/xebialabs/xl-release-server # ls -lrt  reports\n  total 8\n  -rwxrwxrwx 1 10001 40071 2036 May 25 03:50 readme.txt\n  drwxrwsrwx 2 10001 40071 6144 May 25 03:54 testupgrade\n")))),(0,r.kt)("h3",{id:"viii--delete-the-pod"},"viii.  Delete the pod."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'      [sishwarya@localhost docs] $ kubectl delete pod/pod-dai-xlr-digitalai-release\n       pod "pod-dai-xlr-digitalai-release" deleted\n')),(0,r.kt)("h2",{id:"4-run-upgrade-with-dry-run-with-custom-zip-options"},"4. Run upgrade with dry run, with custom zip options."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"   xl op --upgrade --dry-run\n")),(0,r.kt)("h2",{id:"5-take-backup-of-existing-password"},"5. Take backup of existing password."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},' ## To get the admin password for xl-release, run:\n kubectl get secret --namespace default xlr-prod-digitalai-release -o jsonpath="{.data.release-password}" | base64 --decode; echo\n \n ## To get the password for postgresql, run:\n kubectl get secret --namespace default xlr-prod-postgresql -o jsonpath="{.data.postgresql-password}" | base64 --decode; echo\n \n ## To get the password for rabbitMQ, run:\n kubectl get secret --namespace default xlr-prod-rabbitmq  -o jsonpath="{.data.rabbitmq-password}" | base64 --decode; echo\n')),(0,r.kt)("h2",{id:"6-do-following-changes-in-the-xebialabsdai-releasedairelease_cryaml-based-on-the-requirement"},"6. Do following changes in the xebialabs/dai-release/dairelease_cr.yaml, based on the requirement."),(0,r.kt)("h3",{id:"i-to-update-admin-password"},"i. To update admin password"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},'Default  release admin password is "admin", if we need to update below fields.')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"    .spec.AdminPassword: <password from previous installation>\n")),(0,r.kt)("h3",{id:"ii--to-setup-haproxynginx"},"ii.  To setup haproxy/nginx."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"haproxy setup   ",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'   .spec.haproxy-ingress.install = true\n   .spec.nginx-ingress-controller.install = false\n   .spec.ingress.path = "/"\n           \n   ## in the spec.ingress.annotations replace all nginx. settings and put:\n   kubernetes.io/ingress.class: "haproxy"\n   ingress.kubernetes.io/ssl-redirect: "false"\n   ingress.kubernetes.io/rewrite-target: /\n   ingress.kubernetes.io/affinity: cookie\n   ingress.kubernetes.io/session-cookie-name: JSESSIONID\n   ingress.kubernetes.io/session-cookie-strategy: prefix\n   ingress.kubernetes.io/config-backend: |\n   option httpchk GET /ha/health HTTP/1.0\n'))),(0,r.kt)("li",{parentName:"ul"},"nginx controller",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"   .spec.haproxy-ingress.install = false\n   .spec.nginx-ingress-controller.install = true\n")))),(0,r.kt)("h3",{id:"iii-to-update-the-rabbitmq-persistence-storageclass"},"iii. To update the rabbitmq Persistence storageclass."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"   .spec.rabbitmq.persistence.storageClass: <Storage Class to be defined for RabbitMQ>\n")),(0,r.kt)("h3",{id:"iii-to-reuse-existing-claim-for-postgresrabbitmq"},"iii. To reuse existing claim for postgres/rabbitmq"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},'If the release name is different from "dai-xlr" and if we are using embedded database, we need to reuse the existing Claim, for data persistence.'),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Update the following field with existing claim.")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"          .spec.postgresql.persistence.existingClaim\n          .spec.rabbitmq.persistence.existingClaim --\x3e not required, as we dont save any data.\n")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"eg:\n    .spec.postgresql.persistence.existingClaim: data-xlr-prod-postgresql-0\n")),(0,r.kt)("div",{parentName:"li",className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"}," If we are having more than one existing PVC for rabbitmq, we don't use  existingClaim for rabbitmq configuration, instead we can follow the other approach mentioned below for PV reuse."))),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Post helm uninstall, we can also edit postgres/rabbitmq PV as follows, to create the new PVC with existing PV.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Update the postgres pv with following details.      ",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"            claimRef:\n              apiVersion: v1\n              kind: PersistentVolumeClaim\n              name: data-dai-xlr-postgresql-0\n              namespace: default   \n"))),(0,r.kt)("li",{parentName:"ul"},"Update the rabbitmq pv with following details if we need to reuse the PV of rabbitmq.",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"            claimRef:\n              apiVersion: v1\n              kind: PersistentVolumeClaim\n              name: data-dai-xlr-rabbitmq-0\n              namespace: default   \n"))),(0,r.kt)("li",{parentName:"ul"},"Remove the following from PV ","[postgres/rabbitmq]"," while editing.",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"           claimRef:\n            uid:\n            resourceVersion:\n")))))))),(0,r.kt)("h3",{id:"iv-to-setup-oidc"},"iv. To setup oidc"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"By default keycloak will be enabled as default oidc provider.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"To disable oidc and keycloak."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"   .spec.keycloak.install = false\n   .spec.oidc.enabled =  false\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"To disable keycloak and enable external oidc."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"   .spec.keycloak.install = false\n   .spec.oidc.enabled =  true\n   .spec.oidc.external = true\n   ##  update the below fields with external oidc configuration\n   .spec.oidc.accessTokenUri:\n   .spec.oidc.clientId:\n   .spec.oidc.clientSecret:\n   .spec.oidc.emailClaim:\n   .spec.oidc.external:\n   .spec.oidc.fullNameClaim:\n   .spec.oidc.issuer:\n   .spec.oidc.keyRetrievalUri:\n   .spec.oidc.logoutUri:\n   .spec.oidc.postLogoutRedirectUri:\n   .spec.oidc.redirectUri:\n   .spec.oidc.rolesClaim:\n   .spec.oidc.userAuthorizationUri:\n   .spec.oidc..userNameClaim:\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"If keycloak is enabled, then we will be using default embedded database."),(0,r.kt)("div",{parentName:"li",className:"admonition admonition-caution alert alert--warning"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("pre",{parentName:"div"},(0,r.kt)("code",{parentName:"pre"},"    Note:\n        * Post upgrade keycloak pod failed to start with below error. \n            Caused by: org.postgresql.util.PSQLException: FATAL: password authentication failed for user \"keycloak\"\n        * We need to Connect to the pod/dai-xlr-postgresql-0 pod and create the keycloak database.\n            * kuebctl exec -it pod/dai-xlr-postgresql-0 -- bash\n            * psql -U postgres\n            * create database keycloak;\n            * create user keycloak with encrypted password 'keycloak';\n            * grant all privileges on database keycloak to keycloak;\n")))),(0,r.kt)("div",{parentName:"li",className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},(0,r.kt)("a",{parentName:"p",href:"http://localhost:3000/xl-release-kubernetes-operator/docs/manual/manual-upgrade-for-xlr-10#5-take-backup-of-existing-password"},"Postgres password from previous installation"),"."))))))),(0,r.kt)("h2",{id:"7-bring-up-the-xl-deploy-in-docker"},"7. Bring up the xl-deploy in docker."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},' docker run -d -e "ADMIN_PASSWORD=admin" -e "ACCEPT_EULA=Y" -p 4516:4516 --name xld xebialabs/xl-deploy:22.1\n')),(0,r.kt)("h2",{id:"8-uninstall-helm"},"8. Uninstall helm."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"helm uninstall <release name>\n")),(0,r.kt)("h2",{id:"9-below-steps-are-specific-to-aws-eks-cluster-with-sso-access"},"9. Below steps are specific to AWS EKS Cluster, with SSO access."),(0,r.kt)("h3",{id:"1-verify-if-we-have-clusterrole-configured-with-assumerole-trustpolicy"},"1. Verify if we have clusterRole configured with assumeRole trustPolicy."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Update the ClusterRole TrustPolicy with AssumeRole.",(0,r.kt)("div",{parentName:"li",className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"}," ",(0,r.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-user.html"},"Refer AWS Documentation - Creating a role to delegate permissions to an IAM user"),"  "))))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},' {\n            "Effect": "Allow",\n            "Principal": {\n              "AWS": "<add role or user arn here>"\n            },\n            "Action": "sts:AssumeRole"\n        }\n       \n')),(0,r.kt)("h3",{id:"2-configure-iam-users-or-roles-to-your-amazon-eks-cluster"},"2. Configure IAM users or roles to your Amazon EKS cluster."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Update aws-auth configmap of Cluster with the RoleArn and RoleName.",(0,r.kt)("div",{parentName:"li",className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},(0,r.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/eks/latest/userguide/add-user-role.html"},"Refer AWS Documentation - Add IAM users or roles to your Amazon EKS cluster")))))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"mapRoles:\n----\n- groups:\n  - system:bootstrappers\n  - system:nodes\n  rolearn: <add role arn>\n  username: <add role name>\n\n")),(0,r.kt)("h2",{id:"10-run-the-following-command"},"10. Run the following command."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"xl apply -f xebialabs.yaml\n")),(0,r.kt)("h2",{id:"11-verify-the-pvc-and-pv"},"11. Verify the PVC and PV."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"[sishwarya@localhost xl-release-kubernetes-operator] (D-21331) $ kubectl get pvc\nNAME                         STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE\ndai-xlr-digitalai-release    Bound    pvc-dad9e7c3-ae1b-4b28-b595-4f4b281a0bf2   5Gi        RWO            aws-efs-provisioner   146m\ndata-dai-xlr-rabbitmq-0      Bound    pvc-51e2a5f0-8313-4930-a7b7-b7f648064a0a   8Gi        RWO            aws-efs-provisioner   5m32s\ndata-dai-xlr-rabbitmq-1      Bound    pvc-3eb28b33-e45f-4064-a762-fea483d21552   8Gi        RWO            aws-efs-provisioner   5m32s\ndata-dai-xlr-rabbitmq-2      Bound    pvc-8d171e3a-5b3e-4fb3-8873-00db6ada9a4b   8Gi        RWO            aws-efs-provisioner   5m32s\ndata-xlr-prod-postgresql-0   Bound    pvc-38314489-068a-42e7-bc65-cc9491c5457c   50Gi       RWO            aws-efs-provisioner   158m\ndata-xlr-prod-rabbitmq-0     Bound    pvc-f36a89a9-d48d-49dc-a210-a43c7d1a3862   8Gi        RWO            aws-efs-provisioner   158m\ndata-xlr-prod-rabbitmq-1     Bound    pvc-6d03813b-1438-41ee-93c9-3f32efe73e47   8Gi        RWO            aws-efs-provisioner   158m\ndata-xlr-prod-rabbitmq-2     Bound    pvc-808b52b0-4851-44ff-a950-a61e4ff842ca   8Gi        RWO            aws-efs-provisioner   157m\n\n[sishwarya@localhost xl-release-kubernetes-operator] (D-21331) $ kubectl get pv\nNAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS     CLAIM                                STORAGECLASS          REASON   AGE\npvc-38314489-068a-42e7-bc65-cc9491c5457c   50Gi       RWO            Retain           Bound      default/data-xlr-prod-postgresql-0   aws-efs-provisioner            159m\npvc-3eb28b33-e45f-4064-a762-fea483d21552   8Gi        RWO            Delete           Bound      default/data-dai-xlr-rabbitmq-1      aws-efs-provisioner            5m41s\npvc-51e2a5f0-8313-4930-a7b7-b7f648064a0a   8Gi        RWO            Delete           Bound      default/data-dai-xlr-rabbitmq-0      aws-efs-provisioner            5m41s\npvc-6d03813b-1438-41ee-93c9-3f32efe73e47   8Gi        RWO            Retain           Bound      default/data-xlr-prod-rabbitmq-1     aws-efs-provisioner            158m\npvc-783d538b-532f-4ed5-a0be-2ce4fe91975e   5Gi        RWO            Retain           Released   default/xlr-prod-digitalai-release   aws-efs-provisioner            159m\npvc-808b52b0-4851-44ff-a950-a61e4ff842ca   8Gi        RWO            Retain           Bound      default/data-xlr-prod-rabbitmq-2     aws-efs-provisioner            157m\npvc-8d171e3a-5b3e-4fb3-8873-00db6ada9a4b   8Gi        RWO            Delete           Bound      default/data-dai-xlr-rabbitmq-2      aws-efs-provisioner            5m41s\npvc-dad9e7c3-ae1b-4b28-b595-4f4b281a0bf2   5Gi        RWO            Retain           Bound      default/dai-xlr-digitalai-release    aws-efs-provisioner            146m\npvc-f36a89a9-d48d-49dc-a210-a43c7d1a3862   8Gi        RWO            Retain           Bound      default/data-xlr-prod-rabbitmq-0     aws-efs-provisioner            159m\n\n[sishwarya@localhost xl-release-kubernetes-operator] (D-21331) $ \n\n")),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Note:"),(0,r.kt)("ul",{parentName:"div"},(0,r.kt)("li",{parentName:"ul"},"We will see new PVC and PV created for rabbitmq, we can delete the old PVC and PV.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"kubectl delete pvc data-xlr-prod-rabbitmq-0 data-xlr-prod-rabbitmq-1 data-xlr-prod-rabbitmq-2"),(0,r.kt)("li",{parentName:"ul"},"kubectl delete pv pvc-f36a89a9-d48d-49dc-a210-a43c7d1a3862, pvc-6d03813b-1438-41ee-93c9-3f32efe73e47, pvc-808b52b0-4851-44ff-a950-a61e4ff842ca"))),(0,r.kt)("li",{parentName:"ul"},"We are reusing the existing claim for postgres."),(0,r.kt)("li",{parentName:"ul"},"We are using newly created PVC dai-xlr-digitalai-release for xl-release pod. ")))))}m.isMDXComponent=!0}}]);