"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[61],{3905:function(e,t,a){a.d(t,{Zo:function(){return c},kt:function(){return m}});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},l=Object.keys(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),d=p(a),m=r,f=d["".concat(s,".").concat(m)]||d[m]||u[m]||l;return a?n.createElement(f,i(i({ref:t},c),{},{components:a})):n.createElement(f,i({ref:t},c))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=a.length,i=new Array(l);i[0]=d;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:r,i[1]=o;for(var p=2;p<l;p++)i[p]=a[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},522:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return o},contentTitle:function(){return s},metadata:function(){return p},toc:function(){return c},default:function(){return d}});var n=a(7462),r=a(3366),l=(a(7294),a(3905)),i=["components"],o={sidebar_position:6},s="Updating configuration files",p={unversionedId:"manual/updating-configuration-files",id:"manual/updating-configuration-files",isDocsHomePage:!1,title:"Updating configuration files",description:"Prerequisites",source:"@site/docs/manual/updating-configuration-files.md",sourceDirName:"manual",slug:"/manual/updating-configuration-files",permalink:"/xl-release-kubernetes-operator/docs/manual/updating-configuration-files",tags:[],version:"current",sidebarPosition:6,frontMatter:{sidebar_position:6},sidebar:"tutorialSidebar",previous:{title:"On Premises",permalink:"/xl-release-kubernetes-operator/docs/manual/onprem"},next:{title:"Adding truststore files",permalink:"/xl-release-kubernetes-operator/docs/manual/updating-truststore-files"}},c=[{value:"Prerequisites",id:"prerequisites",children:[],level:2},{value:"Update xl-release.conf for Release xl-release.conf",id:"update-xl-releaseconf-for-release-xl-releaseconf",children:[],level:2},{value:"Update configuration file generic example for Release",id:"update-configuration-file-generic-example-for-release",children:[{value:"Upgrade process if you have updated files with config maps",id:"upgrade-process-if-you-have-updated-files-with-config-maps",children:[],level:3}],level:2},{value:"Update configuration file for RabbitMQ",id:"update-configuration-file-for-rabbitmq",children:[],level:2},{value:"Update configuration file for PostgreSql",id:"update-configuration-file-for-postgresql",children:[],level:2},{value:"Upgrade process if you have updated the CR values",id:"upgrade-process-if-you-have-updated-the-cr-values",children:[],level:2}],u={toc:c};function d(e){var t=e.components,a=(0,r.Z)(e,i);return(0,l.kt)("wrapper",(0,n.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"updating-configuration-files"},"Updating configuration files"),(0,l.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Linux environment"),(0,l.kt)("li",{parentName:"ul"},"The kubectl command-line tool"),(0,l.kt)("li",{parentName:"ul"},"The yq command-line tool (",(0,l.kt)("a",{parentName:"li",href:"https://github.com/mikefarah/yq/releases"},"Use the latest binary"),")"),(0,l.kt)("li",{parentName:"ul"},"Access to a Kubernetes cluster with installed Release")),(0,l.kt)("h2",{id:"update-xl-releaseconf-for-release-xl-releaseconf"},"Update xl-release.conf for Release xl-release.conf"),(0,l.kt)("p",null,"Get current xl-release.conf file from the release server node:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"\u276f kubectl cp dai-xlr-digitalai-release-0:/opt/xebialabs/xl-release-server/conf/xl-release.conf ./xl-release.conf\n")),(0,l.kt)("p",null,"Create following template file to append to it the retrieved ",(0,l.kt)("inlineCode",{parentName:"p"},"./xl-release.conf"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"\u276f echo 'apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: xl-release-conf-config-map\n  labels:\n    app: digitalai-release\ndata:\n  xl-release.conf: |' > config-patch-xl-release-conf.yaml.template\n")),(0,l.kt)("p",null,"Merge the files:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"\u276f cat config-patch-xl-release-conf.yaml.template > config-patch-xl-release-conf.yaml\n\u276f sed -e 's/^/     /' xl-release.conf >> config-patch-xl-release-conf.yaml\n")),(0,l.kt)("p",null,"Change the config in the ",(0,l.kt)("inlineCode",{parentName:"p"},"config-patch-xl-release-conf.yaml"),"."),(0,l.kt)("p",null,"Create the config map with ",(0,l.kt)("inlineCode",{parentName:"p"},"config-patch-xl-release-conf.yaml"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"\u276f kubectl create -f config-patch-xl-release-conf.yaml\n")),(0,l.kt)("p",null,"Get all statefulsets (release statefulset will be suffixed with ",(0,l.kt)("inlineCode",{parentName:"p"},"-release"),"):"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"\u276f kubectl get sts -o name\n")),(0,l.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"If you create additional configuration like in following lines note that in during next upgrade process you need create custom image like described\n",(0,l.kt)("a",{parentName:"p",href:"#upgrade-process-if-you-have-updated-files-with-config-maps"},"in the section")))),(0,l.kt)("p",null,"Change the statefulset for the release server by adding volume mounts and volumes:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'\u276f kubectl get statefulset.apps/dai-xlr-digitalai-release -o yaml \\\n    | yq eval \'.spec.template.spec.containers[0].volumeMounts += {\n        "mountPath": "/opt/xebialabs/xl-release-server/conf/xl-release.conf",\n        "name": "xl-release-conf-volume",\n        "subPath": "xl-release.conf"\n      }\' - \\\n    | yq eval \'.spec.template.spec.volumes += [{\n        "name": "xl-release-conf-volume",\n        "configMap": {\n          "name": "xl-release-conf-config-map"\n        }\n      }]\' - \\\n    | kubectl replace -f -\n')),(0,l.kt)("p",null,"Restart Release servers (all release server pods):"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"\u276f kubectl delete pod dai-xlr-digitalai-release-0\n")),(0,l.kt)("h2",{id:"update-configuration-file-generic-example-for-release"},"Update configuration file generic example for Release"),(0,l.kt)("p",null,"You can use following way to update any configuration file on the Release ",(0,l.kt)("inlineCode",{parentName:"p"},"conf")," directory that has template in the ",(0,l.kt)("inlineCode",{parentName:"p"},"default-conf"),"."),(0,l.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"In the following example, we are changing the template file from the ",(0,l.kt)("inlineCode",{parentName:"p"},"default-conf"),", not the direct configuration file from the ",(0,l.kt)("inlineCode",{parentName:"p"},"conf"),".\nThe reason for that is in that way we are able to change environment variables in the container via release CR. Those variables are used during the startup of the pod.\nto evaluate template placeholders to the target file in the ",(0,l.kt)("inlineCode",{parentName:"p"},"conf")," folder."))),(0,l.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"The files in the directory ",(0,l.kt)("inlineCode",{parentName:"p"},"conf")," need to be updated on all replicated server nodes."))),(0,l.kt)("p",null,"Get info to list release pod names and statefulsets:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get pod -o name\nkubectl get sts -o name\n")),(0,l.kt)("p",null,"Setup environment vals:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"change ",(0,l.kt)("inlineCode",{parentName:"li"},"CONFIG_FILE")," variable and ",(0,l.kt)("inlineCode",{parentName:"li"},"PATH_TO_CONFIG_FILE")," to :")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"export PRODUCT=release\nexport POD_NAME=dai-xlr-digitalai-release-0\nexport CONFIG_FILE=xl-release.conf.template\nexport CONFIG_FILE_DASH=${CONFIG_FILE//./-}\nexport PATH_TO_CONFIG_FILE=/opt/xebialabs/xl-$PRODUCT-server/default-conf/$CONFIG_FILE\nexport STATEFUL_SET_NAME=statefulset.apps/dai-xlr-digitalai-release\n")),(0,l.kt)("p",null,"Run set of commands:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl cp $POD_NAME:$PATH_TO_CONFIG_FILE ./$CONFIG_FILE\n\necho \"apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: $CONFIG_FILE_DASH-config-map\n  labels:\n    app: digitalai-$PRODUCT\ndata:\n  $CONFIG_FILE: |\" > config-patch-${CONFIG_FILE}.yaml.template\n  \ncat config-patch-${CONFIG_FILE}.yaml.template > config-patch-${CONFIG_FILE}.yaml\nsed -e 's/^/     /' $CONFIG_FILE >> config-patch-${CONFIG_FILE}.yaml\n")),(0,l.kt)("p",null,"Edit the YAML file and add your custom changes to it: ",(0,l.kt)("inlineCode",{parentName:"p"},"config-patch-${CONFIG_FILE}.yaml")),(0,l.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"If you create additional configuration like in following lines note that in during next upgrade process you need create custom image like described\n",(0,l.kt)("a",{parentName:"p",href:"#upgrade-process-if-you-have-updated-files-with-config-maps"},"in the section")))),(0,l.kt)("p",null,"Create config map on cluster and use it:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'kubectl create -f config-patch-${CONFIG_FILE}.yaml\nkubectl get $STATEFUL_SET_NAME -o yaml \\\n    | yq eval ".spec.template.spec.containers[0].volumeMounts += {\n        \\"mountPath\\": \\"$PATH_TO_CONFIG_FILE\\",\n        \\"name\\": \\"$CONFIG_FILE_DASH-volume\\",\n        \\"subPath\\": \\"$CONFIG_FILE\\"\n      }" - \\\n    | yq eval ".spec.template.spec.volumes += [{\n        \\"name\\": \\"$CONFIG_FILE_DASH-volume\\",\n        \\"configMap\\": {\n          \\"name\\": \\"$CONFIG_FILE_DASH-config-map\\"\n        }\n      }]" - \\\n    | kubectl replace -f -\nkubectl delete pod $POD_NAME\n')),(0,l.kt)("h3",{id:"upgrade-process-if-you-have-updated-files-with-config-maps"},"Upgrade process if you have updated files with config maps"),(0,l.kt)("p",null,"To preserve configuration changes after upgrades, you will need to build custom images of the operator with all custom changes in\nthe statefulsets:"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"Checkout correct branch for the Release helm chart with the target version branch of the operator from here: ",(0,l.kt)("a",{parentName:"li",href:"https://github.com/xebialabs/xl-release-kubernetes-helm-chart"},"xl-release-kubernetes-helm-chart")),(0,l.kt)("li",{parentName:"ol"},"Build the operator with the provided script in the root of the repo: ",(0,l.kt)("inlineCode",{parentName:"li"},"./build_operator.sh")),(0,l.kt)("li",{parentName:"ol"},"Release the operator to the image repository according to the script's guide"),(0,l.kt)("li",{parentName:"ol"},"Use the newly created image as the answer during ",(0,l.kt)("inlineCode",{parentName:"li"},"xl op --upgrade")," execution:",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"Operator image to use (OperatorImageRelease)")))),(0,l.kt)("li",{parentName:"ol"},"After the upgrade, if the upgrade changes the configuration files, transfer the changes to the config-map so the changes could be preserved.")),(0,l.kt)("h2",{id:"update-configuration-file-for-rabbitmq"},"Update configuration file for RabbitMQ"),(0,l.kt)("p",null,"To change configuration of the RabbitMQ use available parameters on the\n",(0,l.kt)("a",{parentName:"p",href:"https://github.com/bitnami/charts/tree/master/bitnami/rabbitmq#parameters"},"RabbitMQ packaged by Bitnami")),(0,l.kt)("h2",{id:"update-configuration-file-for-postgresql"},"Update configuration file for PostgreSql"),(0,l.kt)("p",null,"To change configuration of the PostgreSql use available parameters on the\n",(0,l.kt)("a",{parentName:"p",href:"https://github.com/bitnami/charts/tree/master/bitnami/postgresql#parameters"},"PostgreSQL packaged by Bitnami")),(0,l.kt)("h2",{id:"upgrade-process-if-you-have-updated-the-cr-values"},"Upgrade process if you have updated the CR values"),(0,l.kt)("p",null,"To preserve changed values in the CR use the following:"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"Download operator zip version from the ",(0,l.kt)("a",{parentName:"li",href:"https://dist.xebialabs.com/customer/operator/release/"},"release operator zip"),"\nwith specific provider and version that you will install"),(0,l.kt)("li",{parentName:"ol"},"Run ",(0,l.kt)("inlineCode",{parentName:"li"},"xl op --upgrade")," with answers:")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"Do you want to use a custom operator zip file for Release? (UseOperatorZipRelease): Yes\nRelease operator zip to use (absolute path or URL to the zip) (OperatorZipRelease): [Path to the zip file that you downloaded]\nEdit list of custom resource keys that will migrate to the new Release CR (PreserveCrValuesRelease): [Check comment below]\n")),(0,l.kt)("p",null,"Add all paths where you updated CR values from the original value."))}d.isMDXComponent=!0}}]);